<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RIC AI — CRION</title>
<meta name="theme-color" content="#2343d5" />
<style>
  :root{
    --bg:#f7f8fc; --ink:#0f172a; --muted:#6b7280; --line:#E7EAF3;
    --primary:#2343d5; --primary-2:#2e61ff;
    --purple:#7C3AED; --purple-10:#7C3AED1A; --purple-25:#7C3AED40;
    --lime:#a3e635; --danger:#ef4444;
    --border-blue:#cfe1ff; --border-purple:#e2d6ff; --border-orange:#ffd9bf; --border-lime:#d9f7b8;
  }
  *{box-sizing:border-box}
  body{margin:0;font:15px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
       color:var(--ink);
       background:radial-gradient(1200px 600px at -10% -10%, #eaf0ff 0, #ffffff 55%, #f6f8ff 100%);}
  .wrap{max-width:1240px;margin:0 auto;padding:24px 24px 56px}

  /* HERO (logo à esquerda, título ao centro) */
  .hero{
    position:relative;
    background:linear-gradient(135deg,var(--primary),var(--primary-2));
    color:#fff; border-radius:28px; padding:18px 24px;
    display:grid; grid-template-columns:160px 1fr 160px; align-items:center;
    box-shadow:0 24px 56px var(--purple-10), 0 6px 18px var(--purple-25);
    margin-bottom:26px;
  }
  .logo{
    width:auto; height:44px; border-radius:999px; background:#ffffff22; padding:6px 10px;
    display:block; filter:drop-shadow(0 4px 10px #0001);
  }
  .hero h1{margin:0;text-align:center;font-size:32px;letter-spacing:.5px}

  /* GRID + CARDS */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{
    background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;
    box-shadow:0 18px 42px var(--purple-10), 0 2px 6px var(--purple-10);
  }
  h2{margin:0 0 10px;font-size:18px}
  .tag{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;font-size:13px;margin-bottom:10px;border:1px solid}
  .tag.sites{background:#ebf5ff;border-color:#cfe8ff;color:#1e40af}
  .tag.pdf{background:#f1eaff;border-color:#dacfff;color:#5b21b6}
  .tag.crion{background:#eefcf6;border-color:#cbf5e1;color:#065f46}
  .tag.alert{background:#fff1e6;border-color:#ffdaba;color:#b45309}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:15px;background:#fbfbff}
  .input::placeholder{color:#9aa3b2}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;color:#fff;background:var(--primary);
       box-shadow:0 8px 18px rgba(35,67,213,.28);transition:transform .02s ease, filter .1s}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{filter:saturate(.2);opacity:.6;cursor:not-allowed}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line);box-shadow:none}
  .btn-danger{background:var(--danger); color:#fff; box-shadow:0 8px 18px #EF44443A}
  .btn-small{padding:8px 12px;border-radius:10px;font-weight:800}
  .list{margin:10px 0 0;padding:0;list-style:none}
  .item{padding:10px 0;border-top:1px solid var(--line)}
  .meta{font-size:12px;color:#6b7280;margin-top:2px}
  .snip{color:#374151;font-size:14px;margin:6px 0}
  .small{font-size:12px;color:#6b7280}
  .out{white-space:pre-wrap;min-height:160px;border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:10px;background:#fbfbff}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
  .dots{display:inline-block;margin-left:6px;vertical-align:middle}
  .dots i{display:inline-block;width:6px;height:6px;background:#2563eb;border-radius:50%;margin:0 2px;animation:jump 1s infinite}
  .dots i:nth-child(2){animation-delay:.15s} .dots i:nth-child(3){animation-delay:.3s}
  @keyframes jump{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
  .alert-big{font-size:28px;font-weight:900;color:#b91c1c;text-align:center;margin-top:14px}
  .alert-resp{font-size:14px;font-weight:600;color:#334155;text-align:center;margin-top:6px;text-transform:lowercase}

  /* MODAIS */
  .modal{position:fixed;inset:0;background:#00000059;display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal-box{width:min(560px,92vw);border-radius:16px;padding:18px 16px;color:#0b1220;background:#fff;box-shadow:0 18px 64px #00000040}
  .modal-title{font-weight:900;font-size:18px;margin:0 0 10px}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .modal .input{background:#fff}
  #m2text{font-size:13px;text-transform:lowercase}

  /* FOOTER CREDIT */
  .footer{
    margin:28px auto 0; max-width:1240px; padding:10px 16px;
    display:flex; justify-content:flex-end;
  }
  .badge{
    font-size:12px;color:#111;background:#fff;border:1px solid #E5E7EB;padding:8px 14px;border-radius:999px;
    box-shadow:0 10px 24px #0001,0 2px 6px #0001
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- HERO -->
    <header class="hero">
      <div>
        <img class="logo"
             src="https://raw.githubusercontent.com/HD-TECH-hash/Ric-crion/main/icon.png"
             onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/HD-TECH-hash/supplies/main/logo.png';"
             alt="Logo">
      </div>
      <h1>RIC AI CRION</h1>
      <div><!-- vazio (reservado) --></div>
    </header>

    <div class="grid">
      <!-- ALERTA -->
      <section class="card">
        <div class="tag alert">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row">
          <button id="btnAlert" class="btn">Pesquisar</button>
          <button id="btnAdjust" class="btn btn-plain">Ajustar</button>
        </div>
        <div id="alertMsg"  class="alert-big"   style="display:none">—</div>
        <div id="alertResp" class="alert-resp" style="display:none">—</div>
      </section>

      <!-- SITES OFICIAIS -->
      <section class="card">
        <div class="tag sites">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:10px">
          <input id="qSites" class="input" placeholder="Ex.: vencimento Hapvida, cancelamento Affix, inclusão de RN">
          <button id="btnSites" class="btn">Pesquisar</button>
        </div>
        <div id="outSites" class="out">Digite sua pergunta — responderemos com TEXTO longo + fontes oficiais.</div>
      </section>

      <!-- PDFs -->
      <section class="card">
        <div class="tag pdf">PDFs</div>
        <h2>Manuais do Corretor (Sharepoint)</h2>
        <p class="small">Busca rápida no texto extraído dos PDFs (indexados).</p>
        <div class="row">
          <input id="qPDF" class="input" placeholder="Ex.: Affix, Coparticipação, Carência 30 dias">
          <button id="btnPDF" class="btn" style="min-width:126px">Pesquisar</button>
        </div>
        <div id="pdfStatus" class="small" style="margin-top:6px">—</div>
        <ul id="pdfList" class="list"></ul>
      </section>

      <!-- CRION -->
      <section class="card">
        <div class="tag crion">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="small">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informações.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Retenção, URA, Script de Cobrança, Affix">
          <button id="btnCRION" class="btn" style="min-width:126px">Pesquisar</button>
          <button id="btnReIdxCRION" class="btn btn-danger btn-small" title="Atualiza o índice do CRION">Reindexar</button>
        </div>
        <div id="crionStatus" class="small" style="margin-top:6px">—</div>
        <ul id="crionList" class="list"></ul>
      </section>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="badge">Desenvolvido por Alexandre Cavalcante V3.0</div>
  </div>

  <!-- Modais ALERTA -->
  <div id="modal1" class="modal"><div class="modal-box" style="border:1px solid #cfe1ff">
    <h3 class="modal-title">ALERTA DA OPERAÇÃO</h3>
    <input id="m1text" class="input" placeholder="Digite o texto do alerta">
    <div class="modal-actions">
      <button class="btn btn-plain btn-small" onclick="closeM(1)">Cancelar</button>
      <button id="m1ok" class="btn btn-small" onclick="goM2()">Continuar</button>
    </div>
  </div></div>

  <div id="modal2" class="modal"><div class="modal-box" style="border:1px solid #ffdaba">
    <h3 class="modal-title">nome do responsável</h3>
    <input id="m2text" class="input" placeholder="digite apenas o nome (caixa baixa)">
    <div class="modal-actions">
      <button class="btn btn-plain btn-small" onclick="backM1()">Voltar</button>
      <button id="m2ok" class="btn btn-small" onclick="saveAlert()">Salvar</button>
    </div>
  </div></div>

  <div id="modal3" class="modal"><div class="modal-box" style="border:1px solid #d9f7b8">
    <h3 class="modal-title" style="text-align:center">ALERTA AJUSTADO</h3>
    <div style="text-align:center;margin-top:8px" id="m3ok">✔️</div>
    <div class="modal-actions" style="justify-content:center">
      <button class="btn btn-small" onclick="closeM(3)">OK</button>
    </div>
  </div></div>

<script>
/* =================== CONFIG =================== */
const APP_URL = "https://script.google.com/macros/s/AKfycbyCxPQtobvKtI_aEQIeINrDUYEIq98zSChnAlMUxRYZfMcYdplJP2Z1eypBXdpDE_Q-Dg/exec";

/* =================== HELPERS =================== */
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function dots(txt){ return `${txt} <span class="dots"><i></i><i></i><i></i></span>`; }
function setLoading(btn, on, label, loadingLabel){
  if(!btn) return;
  if(on){ btn.disabled=true; btn.dataset.label=label; btn.innerHTML=loadingLabel||dots("Processando"); }
  else { btn.disabled=false; btn.innerHTML=btn.dataset.label||label; }
}
function humanSize(b){ if(!b||b<=0) return "—"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024 && i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }
function htmlizeLinks(t){ return String(t||'').replace(/(https?:\/\/[^\s)]+)(?=\s|$)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`); }

/* =================== JSONP =================== */
function jsonp(action, params={}){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    params.api = action;
    params.callback = cb;
    const url = APP_URL + '?' + new URLSearchParams(params).toString();
    const s = document.createElement('script');
    s.src = url;
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    s.onerror = ()=>{ reject(new Error('JSONP failed')); cleanup(); };
    function cleanup(){ try{ delete window[cb]; }catch(_){} s.remove(); }
    document.body.appendChild(s);
  });
}
const apiGet  = (action, params={}) => jsonp(action, params);
const apiPost = (action, body={})  => jsonp(action, body); // usamos GET para evitar CORS

/* =================== ALERTA =================== */
const elMsg  = document.getElementById('alertMsg');
const elResp = document.getElementById('alertResp');
document.getElementById('btnAlert').addEventListener('click', async ()=>{
  const btn=document.getElementById('btnAlert');
  elMsg.style.display='none'; elResp.style.display='none';
  setLoading(btn,true,"Pesquisar",dots("Consultando"));
  try{
    const res = await apiGet('alert.get');
    setLoading(btn,false,"Pesquisar");
    if(!res || res.ok===false){ elMsg.textContent="Falha ao consultar."; elMsg.style.display='block'; return; }
    if(!res.found){ elMsg.textContent="Sem recado no momento."; elMsg.style.display='block'; return; }
    elMsg.textContent="🚨 " + (res.mensagem||"—").toUpperCase();
    elMsg.style.display='block';
    if(res.responsavel){
      elResp.textContent=String(res.responsavel||"").toLowerCase();
      elResp.style.display='block';
    }
  }catch(e){
    setLoading(btn,false,"Pesquisar");
    elMsg.textContent='Erro: '+e;
    elMsg.style.display='block'; elResp.style.display='none';
  }
});

/* ALERTA (ajuste) */
let _newAlert = "", _newResp = "";
function openM(id){ document.getElementById('modal'+id).classList.add('show'); }
function closeM(id){ document.getElementById('modal'+id).classList.remove('show'); }
function backM1(){ closeM(2); openM(1); }
document.getElementById('btnAdjust').addEventListener('click', ()=>{
  _newAlert=""; _newResp="";
  document.getElementById('m1text').value=""; document.getElementById('m2text').value="";
  openM(1);
});
function goM2(){
  const btn = document.getElementById('m1ok');
  _newAlert = (document.getElementById('m1text').value||"").trim();
  if(!_newAlert){ document.getElementById('m1text').focus(); return; }
  setLoading(btn,true,"Continuar",dots("Pensando"));
  setTimeout(()=>{ setLoading(btn,false,"Continuar"); closeM(1); openM(2); }, 250);
}
document.getElementById('m2text').addEventListener('input', (e)=>{ e.target.value = (e.target.value||'').toLowerCase(); });
async function saveAlert(){
  const btn = document.getElementById('m2ok');
  _newResp = (document.getElementById('m2text').value||"").trim();
  setLoading(btn,true,"Salvar",dots("Gravando"));
  try{
    await apiPost('alert.set', { mensagem:_newAlert, responsavel:_newResp });
    setLoading(btn,false,"Salvar"); closeM(2); openM(3);
  }catch(e){
    setLoading(btn,false,"Salvar"); closeM(2);
    alert("Falha ao ajustar: "+e);
  }
}

/* =================== SITES (texto longo + fontes) =================== */
document.getElementById('btnSites').addEventListener('click', async ()=>{
  const q=(document.getElementById('qSites').value||'').trim();
  if(!q){ document.getElementById('outSites').textContent='Digite a pergunta.'; return; }
  const out=document.getElementById('outSites'); const btn=document.getElementById('btnSites');
  setLoading(btn,true,"Pesquisar",dots("Pensando")); out.innerHTML=dots("Processando");
  const qRich = q + " — FORMATO: responda em português com texto longo (50–90% do conteúdo relevante) e liste as URLs oficiais no final.";
  try{
    const r = await apiGet('sites.chat', { q: qRich });
    setLoading(btn,false,"Pesquisar");
    const html = htmlizeLinks(r && r.text ? r.text : '—');
    out.innerHTML = html;
  }catch(e){
    setLoading(btn,false,"Pesquisar");
    out.textContent='Erro: '+e;
  }
});

/* =================== PDFs =================== */
document.getElementById('btnPDF').addEventListener('click', doPDF);
document.getElementById('qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
async function doPDF(){
  const q=(document.getElementById('qPDF').value||'').trim();
  const btn=document.getElementById('btnPDF');
  const st=document.getElementById('pdfStatus');
  const ul=document.getElementById('pdfList');
  ul.innerHTML=""; if(!q){ st.textContent='Digite um termo.'; return;}
  setLoading(btn,true,"Pesquisar",dots("Pesquisando"));
  st.innerHTML=dots("Listando arquivos");
  try{
    const res = await apiGet('pdf.search', { q });
    setLoading(btn,false,"Pesquisar");
    if(!res || res.ok===false){ st.textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; st.textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='pdf_'+idx;
      const meta = `<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="small" id="snip_pdf_${idx}">${dots('Carregando prévias')}</div>`;
      frag.appendChild(li);
    });
    ul.appendChild(frag);
    if(items.length){
      let from=0;
      const tick=async ()=>{
        const r = await apiGet('pdf.snippets', { sessionId: res.sessionId, start: from, count: 6 });
        (r.items||[]).forEach(row=>{
          const el=document.getElementById('snip_pdf_'+row.index);
          el.innerHTML=(row.snippets && row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="small">—</span>';
        });
        from=r.to;
        if(from < items.length) setTimeout(tick, 60);
        else st.innerHTML += " • prévias completas";
      };
      tick();
    }
  }catch(e){
    setLoading(btn,false,"Pesquisar");
    st.textContent='Erro: '+e;
  }
}

/* =================== CRION =================== */
document.getElementById('btnCRION').addEventListener('click', doCRION);
document.getElementById('qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
document.getElementById('btnReIdxCRION').addEventListener('click', async ()=>{
  const s=document.getElementById('crionStatus'); s.innerHTML=dots("Reindexando CRION");
  try{
    const r=await apiGet('crion.reindex');
    s.textContent="Index CRION: "+(r && r.ok ? "OK" : "Falhou");
  }catch(e){ s.textContent="Erro: "+e; }
});
async function doCRION(){
  const q=(document.getElementById('qCRION').value||'').trim();
  const btn=document.getElementById('btnCRION');
  const st=document.getElementById('crionStatus');
  const ul=document.getElementById('crionList');
  ul.innerHTML=""; if(!q){ st.textContent='Digite um termo.'; return;}
  setLoading(btn,true,"Pesquisar",dots("Pesquisando"));
  st.innerHTML=dots("Listando arquivos");
  try{
    const res = await apiGet('crion.search', { q });
    setLoading(btn,false,"Pesquisar");
    if(!res || res.ok===false){ st.textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; st.textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
      const meta  = `<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="small" id="snip_crion_${idx}">${dots('Carregando prévias')}</div>`;
      frag.appendChild(li);
    });
    ul.appendChild(frag);
    if(items.length){
      let from=0;
      const tick=async ()=>{
        const r = await apiGet('crion.snippets', { sessionId: res.sessionId, start: from, count: 6 });
        (r.items||[]).forEach(row=>{
          const el=document.getElementById('snip_crion_'+row.index);
          el.innerHTML=(row.snippets && row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="small">—</span>';
        });
        from=r.to;
        if(from < items.length) setTimeout(tick, 60);
        else st.innerHTML += " • prévias completas";
      };
      tick();
    }
  }catch(e){
    setLoading(btn,false,"Pesquisar");
    st.textContent='Erro: '+e;
  }
}
</script>
</body>
</html>
