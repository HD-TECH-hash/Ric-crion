<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RIC AI â€” CRION</title>
<link rel="icon" href="RICai.png" />
<style>
  :root{
    --base:14px;                /* 10% menor */
    --bg:#f6f8ff; --ink:#0f172a; --muted:#6b7280; --line:#e7eaf3;
    --brand:#2882bb;            /* header azul novo */
    --green:#22c55e; --lime:#a3e635;
    --danger:#ef4444;
    --tag:#ede9fe; --tag-ink:#6d28d9;  /* roxo clarinho */
    --shadow:0 18px 36px rgba(99,102,241,.16),0 4px 12px rgba(99,102,241,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at -10% -10%,#eaf1ff 0,#fff 55%,#f6f8ff 100%);
       color:var(--ink);font:var(--base)/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:1120px;margin:0 auto;padding:18px}

  /* HEADER */
  .hero{background:var(--brand);color:#fff;border-radius:22px;padding:14px 18px;
        display:flex;align-items:center;justify-content:space-between;
        box-shadow:0 24px 56px rgba(40,130,187,.22)}
  .h-left,.h-right{display:flex;align-items:center;gap:16px}
  .h-center img{height:46px;display:block;filter:drop-shadow(0 2px 6px #0002)}
  .brand{height:42px;display:block}
  .icon-btn{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
            background:#ffffff22;border:1px solid #ffffff55;backdrop-filter:blur(2px);
            cursor:pointer;transition:transform .15s ease,background .15s ease}
  .icon-btn:hover{transform:translateY(-2px);background:#ffffff33}
  .ico{display:block}

  /* GRID */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}.h-right .brand:last-child{display:none}}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .tag{display:inline-flex;align-items:center;gap:8px;background:var(--tag);color:var(--tag-ink);
       border:1px solid #e9d7ff;border-radius:999px;padding:6px 11px;font-weight:800;font-size:12px;letter-spacing:.3px}
  h2{margin:8px 0 10px;font-size:18px}
  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;background:#fbfbff}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;cursor:pointer}
  .btn-green{background:linear-gradient(180deg,var(--green),var(--lime));box-shadow:0 6px 14px rgba(34,197,94,.24)}
  .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line);box-shadow:none}
  .btn-danger{background:linear-gradient(180deg,#f87171,#ef4444);box-shadow:0 6px 14px rgba(239,68,68,.22)}
  .hint{font-size:12px;color:#6b7280;margin-top:6px}
  .out{white-space:pre-wrap;min-height:120px;border:1px dashed var(--line);border-radius:12px;padding:10px;margin-top:10px;background:#fbfbff}
  .list{margin:10px 0 0;padding:0;list-style:none}
  .item{padding:10px 0;border-top:1px solid var(--line)}
  .meta{font-size:12px;color:#6b7280;margin-top:2px}
  .snip{color:#374151;font-size:13px;margin:6px 0}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}

  /* loaders */
  .busy{display:flex;align-items:center;gap:8px}
  .spinner{width:14px;height:14px;border-radius:50%;border:3px solid #ffffff66;border-top-color:#fff;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bar{position:relative;height:6px;border-radius:999px;background:#e9e9ff;overflow:hidden}
  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#c7b8ff,#a78bfa,#93c5fd);animation:load 1.3s infinite}
  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}

  /* footer */
  footer{margin:18px 0 6px;text-align:center}
  .foot{font-size:11px;color:#94a3b8}

  /* MODAL base */
  .modal{position:fixed;inset:0;background:#00000059;display:none;align-items:center;justify-content:center;z-index:1000}
  .modal-box{width:min(560px,92vw);border-radius:14px;padding:14px;background:#fff;border:1px solid #e7eaf3;box-shadow:0 18px 36px rgba(0,0,0,.18)}
  .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .pill{border-radius:999px;padding:8px 12px;border:1px solid #e7eaf3;background:#f8fafc}

  /* CALCULADORA (flutuante, oculta) */
  #calcWrap{position:fixed;top:94px;right:18px;z-index:1200;display:none}
  .calc{width:300px;border-radius:16px;border:1px solid #e7eaf3;background:#fff;box-shadow:0 18px 36px rgba(2,6,23,.18)}
  .calc-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e7eaf3}
  .calc-screen{padding:10px 12px;text-align:right;font-weight:700;font-size:22px;min-height:36px}
  .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px}
  .k{padding:10px;border-radius:10px;border:1px solid #e7eaf3;background:#f8fafc;cursor:pointer;font-weight:700}
  .k.op{background:#fee2e2}
  .k.eq{background:#dcfce7}

  /* alerta de integraÃ§Ã£o */
  #err{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#fff;border:1px solid #fecaca;
       box-shadow:0 10px 24px rgba(0,0,0,.12);padding:10px 12px;border-radius:12px;color:#991b1b;display:none;z-index:2000}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="hero">
    <div class="h-left"><img class="brand" src="icon.png" alt="Logo esquerdo"></div>
    <div class="h-center"><img src="RICai.png" alt="RIC AI"></div>
    <div class="h-right" style="gap:12px">
      <!-- POST-IT -->
      <button class="icon-btn" id="btnNotes" title="Post-its">
        <svg class="ico" width="24" height="24" viewBox="0 0 24 24" fill="#ffd54f" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 3h12a2 2 0 0 1 2 2v9.6a2 2 0 0 1-.59 1.42l-3.39 3.39A2 2 0 0 1 14.6 20H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Zm8.6 15H17v-2.4L14.6 18Z"/>
        </svg>
      </button>
      <!-- CALCULADORA -->
      <button class="icon-btn" id="btnCalc" title="Calculadora">
        <svg class="ico" width="24" height="24" viewBox="0 0 24 24" fill="#22c55e" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 2h12a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm1 3v4h10V5H7Zm0 6h3v3H7v-3Zm4 0h3v3h-3v-3Zm4 0h3v3h-3v-3ZM7 15h3v3H7v-3Zm4 0h3v3h-3v-3Zm4 0h3v3h-3v-3Z"/>
        </svg>
      </button>
      <img class="brand" src="icon2.png" alt="Logo direito">
    </div>
  </div>

  <!-- GRID -->
  <div class="grid">
    <section class="card">
      <div class="tag">ALERTA</div>
      <h2>Controle de alerta</h2>
      <div class="row">
        <button id="btnAlert" class="btn btn-green">Pesquisar</button>
        <button id="btnAdjust" class="btn btn-plain">Ajustar</button>
      </div>
      <div class="hint" id="alertBusy" style="display:none">
        <div class="busy"><div class="spinner"></div><div>Pesquisando alertaâ€¦</div></div>
        <div class="bar" style="margin-top:6px"></div>
      </div>
      <div id="alertMsg"  style="display:none;font-size:22px;font-weight:900;color:#b91c1c;text-align:center;margin-top:8px">â€”</div>
      <div id="alertResp" style="display:none;font-size:13px;font-weight:600;color:#334155;text-align:center;margin-top:4px;text-transform:lowercase">â€”</div>
    </section>

    <section class="card">
      <div class="tag">SITES OFICIAIS</div>
      <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
      <div class="row" style="margin-top:6px">
        <input id="qSites" class="input" placeholder="Digite sua pergunta â€¦..">
        <button id="btnSites" class="btn btn-green">Pesquisar</button>
      </div>
      <div class="hint" id="sitesBusy" style="display:none">
        <div class="busy"><div class="spinner"></div><div>Pesquisandoâ€¦</div></div>
        <div class="bar" style="margin-top:6px"></div>
      </div>
      <div id="outSites" class="out">â€”</div>
    </section>

    <section class="card">
      <div class="tag">PDFs</div>
      <h2>Manuais do Corretor (Sharepoint)</h2>
      <p class="hint">Busca rÃ¡pida no texto extraÃ­do dos PDFs (indexados).</p>
      <div class="row">
        <input id="qPDF" class="input" placeholder="Ex.: Affix, CoparticipaÃ§Ã£o, CarÃªncia 30 dias">
        <button id="btnPDF" class="btn btn-green" style="min-width:120px">Pesquisar</button>
      </div>
      <div class="hint" id="pdfBusy" style="display:none">
        <div class="busy"><div class="spinner"></div><div>Listando arquivosâ€¦</div></div>
        <div class="bar" style="margin-top:6px"></div>
      </div>
      <div id="pdfStatus" class="hint" style="margin-top:6px">â€”</div>
      <ul id="pdfList" class="list"></ul>
    </section>

    <section class="card">
      <div class="tag">PROCEDIMENTOS CRION</div>
      <h2>Procedimentos</h2>
      <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informaÃ§Ãµes.</p>
      <div class="row">
        <input id="qCRION" class="input" placeholder="Ex.: Onboarding, RetenÃ§Ã£o, URA, Script de CobranÃ§a, Affix">
        <button id="btnCRION" class="btn btn-green" style="min-width:120px">Pesquisar</button>
        <button id="btnReIdxCRION" class="btn btn-danger" style="min-width:120px">Reindexar</button>
      </div>
      <div class="hint" id="crionBusy" style="display:none">
        <div class="busy"><div class="spinner"></div><div>Listando procedimentosâ€¦</div></div>
        <div class="bar" style="margin-top:6px"></div>
      </div>
      <div id="crionStatus" class="hint" style="margin-top:6px">â€”</div>
      <ul id="crionList" class="list"></ul>
    </section>
  </div>

  <footer><span class="foot">Desenvolvido por Alexandre Cavalcante V3.0</span></footer>
</div>

<!-- MODAL POST-ITS -->
<div id="modalNotes" class="modal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 style="margin:0">Post-its</h3>
      <div class="row">
        <button id="btnClearNotes" class="pill">Limpar</button>
        <button id="btnCloseNotes" class="pill">Fechar</button>
      </div>
    </div>
    <div class="row">
      <input id="noteTitle" class="input" placeholder="TÃ­tulo">
      <button id="btnAddNote" class="btn btn-green">Adicionar</button>
    </div>
    <textarea id="noteText" class="input" style="margin-top:10px;height:120px;background:#fff8db"></textarea>
    <div id="notesList" class="list" style="margin-top:10px"></div>
  </div>
</div>

<!-- CALCULADORA -->
<div id="calcWrap">
  <div class="calc">
    <div class="calc-head"><strong>Calculadora</strong><button class="pill" onclick="toggleCalc(false)">Fechar</button></div>
    <div id="calcScreen" class="calc-screen">0</div>
    <div class="keys">
      <button class="k" data-k="C">C</button><button class="k" data-k="Â±">Â±</button><button class="k" data-k="%">%</button><button class="k op" data-k="Ã·">Ã·</button>
      <button class="k" data-k="7">7</button><button class="k" data-k="8">8</button><button class="k" data-k="9">9</button><button class="k op" data-k="Ã—">Ã—</button>
      <button class="k" data-k="4">4</button><button class="k" data-k="5">5</button><button class="k" data-k="6">6</button><button class="k op" data-k="-">âˆ’</button>
      <button class="k" data-k="1">1</button><button class="k" data-k="2">2</button><button class="k" data-k="3">3</button><button class="k op" data-k="+">+</button>
      <button class="k" data-k="0" style="grid-column:span 2">0</button><button class="k" data-k=".">.</button><button class="k eq" data-k="=">=</button>
    </div>
  </div>
</div>

<!-- aviso de erro -->
<div id="err"></div>

<script>
/* ===== CONFIG ===== */
const APP_URL = "https://script.google.com/macros/s/AKfycbw6uzRI4069YZmoizZFB0p8XmPqw1dw_IfxFaKGd33_3HQDF5RbBc-4_dHLj1YmCNGDgQ/exec";

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? '' : 'none'; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function humanSize(b){ if(!b||b<=0) return "â€”"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }
function toast(msg){ const e=$("#err"); e.innerHTML = esc(msg); show(e,true); setTimeout(()=>show(e,false), 4500); }

/* ===== POLYFILL (sem preflight) ===== */
async function call(endpoint, payload){
  const body = new URLSearchParams();
  body.set("fn", endpoint);
  body.set("payload", JSON.stringify(payload||{}));
  let res;
  try{
    res = await fetch(APP_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body
    });
  }catch(e){
    toast("Falha de rede: "+e.message);
    throw e;
  }
  if(!res.ok){ toast("HTTP "+res.status); throw new Error("HTTP "+res.status); }
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch{ return {ok:false, message:"Resposta invÃ¡lida do servidor", raw:txt}; }
}

/* ===== HEADER ICONS ===== */
$('#btnNotes').addEventListener('click', ()=>{ renderNotes(); show($('#modalNotes'),true); });
$('#btnCloseNotes').addEventListener('click', ()=> show($('#modalNotes'),false));

$('#btnCalc').addEventListener('click', ()=> toggleCalc());
function toggleCalc(force){ const el=$('#calcWrap'); if(typeof force==='boolean'){show(el,force);return;} show(el, el.style.display==='none' || !el.style.display); }

/* ===== CALC ===== */
(function calc(){
  const scr = $('#calcScreen'); let a=null, op=null, cur='0';
  const draw=()=> scr.textContent=cur;
  const eq=()=>{ const x=a!==null?a:parseFloat(cur), y=parseFloat(cur); let r=y;
    if(op==='+') r=x+y; else if(op==='âˆ’'||op==='-') r=x-y; else if(op==='Ã—') r=x*y; else if(op==='Ã·') r=(y===0?0:x/y);
    cur=String(r); a=null; op=null; draw(); };
  document.querySelectorAll('.k').forEach(b=>b.addEventListener('click', ()=>{
    const k=b.dataset.k;
    if(/[0-9]/.test(k)){ cur=(cur==='0')?k:(cur+k); return draw(); }
    if(k==='.'){ if(!cur.includes('.')) cur+='.'; return draw(); }
    if(k==='C'){ a=null; op=null; cur='0'; return draw(); }
    if(k==='Â±'){ cur=String(parseFloat(cur)*-1); return draw(); }
    if(k==='%'){ cur=String(parseFloat(cur)/100); return draw(); }
    if(k==='=') return eq();
    a=parseFloat(cur); op=k; cur='0'; draw();
  })); draw();
})();

/* ===== POST-ITS (localStorage) ===== */
const LS="ric_notes";
$('#btnClearNotes').addEventListener('click', ()=>{ localStorage.removeItem(LS); renderNotes(); });
$('#btnAddNote').addEventListener('click', ()=>{
  const title=($('#noteTitle').value||'').trim(); const text=($('#noteText').value||'').trim();
  if(!text){ $('#noteText').focus(); return; }
  const arr=JSON.parse(localStorage.getItem(LS)||"[]"); arr.unshift({title,text,at:Date.now()});
  localStorage.setItem(LS, JSON.stringify(arr)); $('#noteTitle').value=""; $('#noteText').value=""; renderNotes();
});
function renderNotes(){
  const box=$('#notesList'); box.innerHTML="";
  const arr=JSON.parse(localStorage.getItem(LS)||"[]");
  if(!arr.length){ box.innerHTML='<div class="hint">Sem post-its salvos.</div>'; return; }
  const frag=document.createDocumentFragment();
  arr.forEach((n,i)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${esc(n.title||'Sem tÃ­tulo')}</b> <span class="meta">â€¢ ${new Date(n.at).toLocaleString()}</span></div>
                   <div class="snip">${esc(n.text)}</div>
                   <div class="row" style="justify-content:flex-end"><button class="pill" onclick="delNote(${i})">Excluir</button></div>`;
    frag.appendChild(div);
  }); box.appendChild(frag);
}
window.delNote=function(i){ const arr=JSON.parse(localStorage.getItem(LS)||"[]"); arr.splice(i,1); localStorage.setItem(LS,JSON.stringify(arr)); renderNotes(); };

/* ===== AÃ‡Ã•ES ===== */
$('#btnAlert').addEventListener('click', async ()=>{
  const msg=$('#alertMsg'), resp=$('#alertResp');
  show(msg,false); show(resp,false); show($('#alertBusy'),true);
  try{
    const r=await call('getalert',{});
    if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; show(msg,true); if(r && r.message) toast(r.message); return; }
    if(!r.found){ msg.textContent="Sem recado no momento."; show(msg,true); return; }
    msg.textContent="ðŸš¨ "+String(r.mensagem||"â€”").toUpperCase(); show(msg,true);
    if(r.responsavel){ resp.textContent=String(r.responsavel||"").toLowerCase(); show(resp,true); }
  }catch(e){ msg.textContent="Erro: "+e.message; show(msg,true);
  }finally{ show($('#alertBusy'),false); }
});

$('#btnAdjust').addEventListener('click', async ()=>{
  const t=prompt("Texto do alerta (vermelho):"); if(!t) return;
  const r=prompt("ResponsÃ¡vel (primeira letra maiÃºscula):"); if(!r) return;
  try{ await call('adjustalert',{mensagem:t,responsavel:r}); alert("Alerta ajustado!"); }
  catch(e){ toast("Falha ao ajustar: "+e.message); }
});

$('#btnSites').addEventListener('click', async ()=>{
  const q=($('#qSites').value||'').trim();
  if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
  show($('#sitesBusy'),true); $('#outSites').textContent='â€”';
  try{
    const qRich=q+" â€” FORMATO: responda em portuguÃªs com texto longo (50â€“90% do conteÃºdo relevante) e liste as URLs oficiais no final. Substitua qualquer nota genÃ©rica por: 'Fontes oficiais Affix, Alter, Hapvida'.";
    const r=await call('chat',{q:qRich});
    const txt=(r && (r.text||r.answer))?(r.text||r.answer):'â€”';
    const html=String(txt).replace(/(https?:\/\/[^\s]+)/g,m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
    $('#outSites').innerHTML=html;
  }catch(e){ $('#outSites').textContent='Erro: '+e.message;
  }finally{ show($('#sitesBusy'),false); }
});

$('#btnPDF').addEventListener('click', doPDF);
$('#qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
async function doPDF(){
  const q=($('#qPDF').value||'').trim(); if(!q){ $('#pdfStatus').textContent='Digite um termo.'; return; }
  show($('#pdfBusy'),true); $('#pdfStatus').textContent='Listando arquivos...'; $('#pdfList').innerHTML="";
  try{
    const res=await call('searchindexed',{q});
    if(!res || res.ok===false){ $('#pdfStatus').textContent='Erro ao buscar'; if(res && res.message) toast(res.message); return; }
    const items=res.items||[]; $('#pdfStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='pdf_'+idx;
      const meta=`<div class="meta">Tamanho: ${humanSize(it.size||0)} â€¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "â€”"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> â€¢ ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_pdf_${idx}">Carregando prÃ©viasâ€¦</div>`;
      frag.appendChild(li);
    }); $('#pdfList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r=await call('fetchindexedsnippets',{sessionId:res.sessionId,from,limit:6});
        (r.items||[]).forEach(row=>{
          const el=$('#snip_pdf_'+row.index);
          el.innerHTML=(row.snippets&&row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="hint">â€”</span>';
        });
        from=r.to;
      }
      $('#pdfStatus').textContent+=' â€¢ prÃ©vias completas';
    }
  }catch(e){ $('#pdfStatus').textContent='Erro: '+e.message;
  }finally{ show($('#pdfBusy'),false); }
}

$('#btnCRION').addEventListener('click', doCRION);
$('#qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
$('#btnReIdxCRION').addEventListener('click', async ()=>{
  $('#crionStatus').textContent='Reindexando CRIONâ€¦'; show($('#crionBusy'),true);
  try{ const r=await call('reindexcrion',{}); $('#crionStatus').textContent="Index CRION: "+(r && r.ok ? "OK" : "Falhou"); }
  catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
  finally{ show($('#crionBusy'),false); }
});
async function doCRION(){
  const q=($('#qCRION').value||'').trim(); if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
  show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivosâ€¦'; $('#crionList').innerHTML="";
  try{
    const res=await call('searchcrion',{q});
    if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar'; if(res && res.message) toast(res.message); return; }
    const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
      const meta=`<div class="meta">Tamanho: ${humanSize(it.size||0)} â€¢ Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "â€”"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> â€¢ ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_crion_${idx}">Carregando prÃ©viasâ€¦</div>`;
      frag.appendChild(li);
    }); $('#crionList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r=await call('fetchcrionsnippets',{sessionId:res.sessionId,from,limit:6});
        (r.items||[]).forEach(row=>{
          const el=$('#snip_crion_'+row.index);
          el.innerHTML=(row.snippets&&row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="hint">â€”</span>';
        });
        from=r.to;
      }
      $('#crionStatus').textContent+=' â€¢ prÃ©vias completas';
    }
  }catch(e){ $('#crionStatus').textContent='Erro: '+e.message;
  }finally{ show($('#crionBusy'),false); }
}
</script>
</body>
</html>
