<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RIC AI — CRION</title>
<!-- (mesmos estilos do arquivo do GAS) -->
<style>
/* …identico ao do GAS… (copie exatamente o <style> acima) */
</style>
</head>
<body>
  <!-- (mesma marcação HTML do GAS, copie exatamente o <body> até antes do <script>) -->

  <!-- …copie a MESMA marcação do GAS… -->

<script>
/*** CONFIG: sua URL do Web App GAS (deploy “Anyone”) ***/
const APP_URL = "https://script.google.com/macros/s/SEU_ID/exec";

/*** helpers iguais ***/
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.style.display = on? '' : 'none'; };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function humanSize(b){ if(!b||b<=0) return "—"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }

/*** Polyfill — chama seu APP_URL ***/
function call(endpoint, payload){
  const url = APP_URL + "?fn=" + encodeURIComponent(endpoint);
  return fetch(url, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify(payload||{}) })
    .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); });
}

/*** (o restante do JS é o mesmo comportamento, só trocando google.script.run → call) ***/
/*** Draggable, Notes, Calculator — iguais ao GAS ***/
function makeDraggable(win, head){
  let x=0,y=0,ix=0,iy=0,drag=false;
  head.onmousedown = e=>{ drag=true; ix=e.clientX; iy=e.clientY; document.onmouseup=stop; document.onmousemove=move; };
  function move(e){ if(!drag) return; x += e.clientX-ix; y += e.clientY-iy; ix=e.clientX; iy=e.clientY; win.style.transform=`translate(${x}px,${y}px)`; }
  function stop(){ drag=false; document.onmouseup=null; document.onmousemove=null; }
}
const calcWrap = document.getElementById('calcWrap'), notesWrap = document.getElementById('notesWrap');
document.getElementById('openCalc').onclick = ()=>toggleCalc(true);
document.getElementById('openNotes').onclick = ()=>toggleNotes(true);
function toggleCalc(on){ show(calcWrap,on); }
function toggleNotes(on){ show(notesWrap,on); }
makeDraggable(document.getElementById('calcWin'), document.getElementById('calcHead'));
makeDraggable(document.getElementById('notesWin'), document.getElementById('notesHead'));

const NOTE_KEY='RIC_NOTE_V1';
const noteEl=document.getElementById('noteText');
noteEl.value = localStorage.getItem(NOTE_KEY)||'';
noteEl.addEventListener('input', ()=>localStorage.setItem(NOTE_KEY, noteEl.value));
function clearNote(){ if(confirm('Limpar anotação?')){ noteEl.value=''; localStorage.removeItem(NOTE_KEY); }}

/*** Calculator ***/
let expr=''; const screen=document.getElementById('calcScreen');
document.querySelectorAll('.calc-btn').forEach(b=>b.onclick=()=>{
  const k=b.dataset.k;
  if(k==='C'){ expr=''; screen.textContent='0'; return; }
  if(k==='='){
    try{
      const safe = expr.replace(/×/g,'*').replace(/÷/g,'/').replace(/[^0-9+/*().\-]/g,'');
      const res = Function('return ('+safe+')')();
      screen.textContent = String(res); expr = String(res);
    }catch(_){ screen.textContent='Erro'; expr=''; }
    return;
  }
  expr += k; screen.textContent = expr;
});

/*** Modais ALERTA (idênticos) ***/
function openM(id){ document.getElementById('modal'+id).style.display='flex'; }
function closeM(id){ document.getElementById('modal'+id).style.display='none'; }
function backM1(){ closeM(2); openM(1); }

/*** ALERTA ***/
document.getElementById('btnAlert').addEventListener('click', async ()=>{
  const msg=document.getElementById('alertMsg'), resp=document.getElementById('alertResp');
  show(msg,false); show(resp,false); show(document.getElementById('alertBusy'),true);
  try{
    const r=await call('getalert',{});
    if(!r || r.ok===false){ msg.textContent="Falha ao consultar."; show(msg,true); }
    else if(!r.found){ msg.textContent="Sem recado no momento."; show(msg,true); }
    else{ msg.textContent="🚨 "+String(r.mensagem||"—").toUpperCase(); show(msg,true); if(r.responsavel){ resp.textContent=String(r.responsavel||"").toLowerCase(); show(resp,true);} }
  }catch(e){ msg.textContent="Erro: "+e.message; show(msg,true); }
  finally{ show(document.getElementById('alertBusy'),false); }
});

/*** ALERTA (ajuste) ***/
let _newAlert="", _newResp="";
document.getElementById('btnAdjust').addEventListener('click', ()=>{ _newAlert=""; _newResp=""; document.getElementById('m1text').value=""; document.getElementById('m2text').value=""; openM(1); });
function goM2(){ _newAlert=(document.getElementById('m1text').value||"").trim(); if(!_newAlert){ document.getElementById('m1text').focus(); return; } closeM(1); openM(2); }
document.getElementById('m2text').addEventListener('input', e=>{ const v=e.target.value; e.target.value = v? v[0].toUpperCase()+v.slice(1).toLowerCase():v; });
async function saveAlert(){
  _newResp = document.getElementById('m2text').value.trim();
  const btn=document.getElementById('m2ok'); btn.disabled=true; btn.textContent='Salvando...';
  try{ await call('adjustalert',{mensagem:_newAlert,responsavel:_newResp}); closeM(2); openM(3); }
  catch(e){ closeM(2); alert("Falha ao ajustar: "+e.message); }
  finally{ btn.disabled=false; btn.textContent='Salvar'; }
}

/*** SITES ***/
document.getElementById('btnSites').addEventListener('click', async ()=>{
  const q=(document.getElementById('qSites').value||'').trim();
  if(!q){ document.getElementById('outSites').textContent='Digite a pergunta.'; return; }
  show(document.getElementById('sitesBusy'),true); document.getElementById('outSites').textContent='—';
  try{
    const qRich = q + " — FORMATO: responda em português com texto longo (50–90% do conteúdo relevante) e liste as URLs oficiais no final.";
    const r = await call('chat',{q:qRich}); const txt = (r && r.text) ? r.text : '—';
    const html = String(txt).replace(/(https?:\/\/[^\s]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
    document.getElementById('outSites').innerHTML=html;
  }catch(e){ document.getElementById('outSites').textContent='Erro: '+e.message; }
  finally{ show(document.getElementById('sitesBusy'),false); }
});

/*** PDFs ***/
document.getElementById('btnPDF').addEventListener('click', doPDF);
document.getElementById('qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
async function doPDF(){
  const q=(document.getElementById('qPDF').value||'').trim();
  if(!q){ document.getElementById('pdfStatus').textContent='Digite um termo.'; return; }
  show(document.getElementById('pdfBusy'),true); document.getElementById('pdfStatus').textContent='Listando arquivos...'; document.getElementById('pdfList').innerHTML="";
  try{
    const res=await call('searchindexed',{q});
    if(!res || res.ok===false){ document.getElementById('pdfStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; document.getElementById('pdfStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='pdf_'+idx;
      const meta=`<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString():"—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_pdf_${idx}">Carregando prévias…</div>`;
      frag.appendChild(li);
    }); document.getElementById('pdfList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r = await call('fetchindexedsnippets',{sessionId:res.sessionId, from, limit:6});
        (r.items||[]).forEach(row=>{
          const el=document.getElementById('snip_pdf_'+row.index);
          el.innerHTML=(row.snippets&&row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join(""):'<span class="hint">—</span>';
        });
        from=r.to;
      }
      document.getElementById('pdfStatus').textContent += " • prévias completas";
    }
  }catch(e){ document.getElementById('pdfStatus').textContent='Erro: '+e.message; }
  finally{ show(document.getElementById('pdfBusy'),false); }
}

/*** CRION ***/
document.getElementById('btnCRION').addEventListener('click', doCRION);
document.getElementById('qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
document.getElementById('btnReIdxCRION').addEventListener('click', async ()=>{
  document.getElementById('crionStatus').textContent='Reindexando CRION…'; show(document.getElementById('crionBusy'),true);
  try{ const r=await call('reindexcrion',{}); document.getElementById('crionStatus').textContent="Index CRION: "+(r && r.ok ? "OK":"Falhou"); }
  catch(e){ document.getElementById('crionStatus').textContent='Erro: '+e.message; }
  finally{ show(document.getElementById('crionBusy'),false); }
});
async function doCRION(){
  const q=(document.getElementById('qCRION').value||'').trim();
  if(!q){ document.getElementById('crionStatus').textContent='Digite um termo.'; return; }
  show(document.getElementById('crionBusy'),true); document.getElementById('crionStatus').textContent='Listando arquivos…'; document.getElementById('crionList').innerHTML="";
  try{
    const res=await call('searchcrion',{q});
    if(!res || res.ok===false){ document.getElementById('crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; document.getElementById('crionStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
      const meta=`<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString():"—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_crion_${idx}">Carregando prévias…</div>`;
      frag.appendChild(li);
    }); document.getElementById('crionList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r = await call('fetchcrionsnippets',{sessionId:res.sessionId, from, limit:6});
        (r.items||[]).forEach(row=>{
          const el=document.getElementById('snip_crion_'+row.index);
          el.innerHTML=(row.snippets&&row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join(""):'<span class="hint">—</span>';
        });
        from=r.to;
      }
      document.getElementById('crionStatus').textContent += " • prévias completas";
    }
  }catch(e){ document.getElementById('crionStatus').textContent='Erro: '+e.message; }
  finally{ show(document.getElementById('crionBusy'),false); }
}
</script>
</body>
</html>
