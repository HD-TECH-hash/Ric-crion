<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RIC AI — CRION</title>
<style>
  :root{
    --bg:#f7f8fc; --ink:#0f172a; --muted:#6b7280; --line:#E7EAF3;
    --primary:#2343d5; --primary-2:#2e61ff; --danger:#ef4444; --lime:#22c55e;
    --card-shadow:0 16px 36px #7C3AED26,0 2px 6px #7C3AED26;
    --glow:0 24px 56px rgba(46,97,255,.22), 0 2px 10px rgba(46,97,255,.20);
    --shadow-blue:0 12px 26px rgba(37,99,235,.22), 0 2px 6px rgba(37,99,235,.16);

    /* tags lilás claras */
    --tag-bg:#f3e8ff; --tag-text:#5b21b6; --tag-border:#e9d5ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font:15px/1.55 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:radial-gradient(1200px 600px at -10% -10%, #eaf0ff 0, #ffffff 55%, #f6f8ff 100%);
    color:var(--ink)
  }
  .wrap{max-width:1240px;margin:0 auto;padding:24px}
  /* ↓ 20% menor em telas largas (GitHub costuma “parecer maior”) */
  @media (min-width: 1060px){
    .wrap.scale-80{ transform:scale(.8); transform-origin: top center; }
  }

  /* HEADER (glow) */
  .hero{
    position:relative;background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;
    border-radius:28px;padding:18px 24px;display:flex;align-items:center;justify-content:center;
    box-shadow:var(--glow); margin-bottom:22px; min-height:86px;
  }
  .hero h1{margin:0;font-size:30px;letter-spacing:.5px}
  .logo{height:40px;width:auto;object-fit:contain;filter:drop-shadow(0 2px 6px #0002)}
  .logo-left{position:absolute;left:22px;top:50%;transform:translateY(-50%)}
  .logo-right{position:absolute;right:22px;top:50%;transform:translateY(-50%)}
  @media (max-width:680px){ .logo-right{display:none} }

  /* GRID / CARDS */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--card-shadow)}

  h2{margin:0 0 10px;font-size:18px}

  /* TAG lilás clarinha com shadow azul */
  .tag{
    display:inline-flex;align-items:center;justify-content:center;
    padding:6px 14px;border-radius:999px;font-weight:800;letter-spacing:.2px;
    color:var(--tag-text);background:var(--tag-bg);
    box-shadow:var(--shadow-blue);border:1px solid var(--tag-border);
    width:max-content;margin-bottom:10px
  }

  .row{display:flex;gap:10px;align-items:center}
  .input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:15px;background:#fbfbff}
  .input::placeholder{color:#9aa3b2}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;color:#fff;background:var(--primary);box-shadow:0 8px 18px rgba(35,67,213,.28)}
  .btn:active{transform:translateY(1px)} .btn-plain{background:#f7f7fb;color:#111;border:1px solid var(--line);box-shadow:none}
  .btn-danger{background:var(--danger);color:#fff;box-shadow:0 8px 18px #EF44443A}
  .btn-small{padding:8px 12px;border-radius:10px;font-weight:800}
  .out{white-space:pre-wrap;min-height:160px;border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:10px;background:#fbfbff}
  .list{margin:10px 0 0;padding:0;list-style:none} .item{padding:10px 0;border-top:1px solid var(--line)}
  .meta{font-size:12px;color:#6b7280;margin-top:2px}
  .snip{color:#374151;font-size:14px;margin:6px 0}
  a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}

  /* BUSY (loader + barra) */
  .busy{display:flex;align-items:center;gap:10px}
  .spinner{width:16px;height:16px;border-radius:50%;border:3px solid #2343d533;border-top-color:#2343d5;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bar{position:relative;height:8px;border-radius:999px;background:#e9e9ff;overflow:hidden}
  .bar:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,#b7a7ff,#8b5cf6,#60a5fa);animation:load 1.3s infinite}
  @keyframes load{0%{left:-100%;right:100%}50%{left:0;right:0}100%{left:100%;right:-100%}}
  .hint{font-size:12px;color:#6b7280;margin-top:6px}
  .hide{display:none}

  /* ALERTA grande com sirene pulse */
  .alert-big{font-size:28px;font-weight:900;color:#b91c1c;text-align:center;margin-top:14px}
  .alert-big .siren{display:inline-block;margin-right:8px;animation:pulse 1.2s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
  .alert-resp{font-size:14px;font-weight:600;color:#334155;text-align:center;margin-top:6px;text-transform:lowercase}

  /* MODAIS */
  .modal{position:fixed;inset:0;background:#00000059;display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal-box{width:min(560px,92vw);border-radius:16px;padding:18px 16px;color:#0b1220;background:#fff;box-shadow:0 18px 64px #00000040}
  .modal-title{font-weight:900;font-size:18px;margin:0 0 10px;text-align:center}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .modal .input{background:#fff}
  .modal-red{border:1px solid #ffd0d0;box-shadow:0 12px 28px #ef444433}
  .modal-red .modal-title{color:#991b1b}

  footer{margin-top:26px;text-align:center}
  .badge{display:inline-block;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:8px 14px;color:#111;box-shadow:0 10px 22px rgba(124,58,237,.14), 0 2px 6px rgba(124,58,237,.10)}
</style>
</head>
<body>
  <div class="wrap scale-80"><!-- remove "scale-80" se quiser tamanho normal -->
    <div class="hero">
      <img class="logo logo-left" src="icon.png" alt="Logo esquerdo">
      <h1>RIC AI CRION</h1>
      <img class="logo logo-right" src="icon2.png" alt="Logo direito">
    </div>

    <div class="grid">
      <!-- ALERTA -->
      <section class="card">
        <div class="tag">ALERTA</div>
        <h2>Controle de alerta</h2>
        <div class="row">
          <button id="btnAlert" class="btn">Pesquisar</button>
          <button id="btnAdjust" class="btn btn-plain">Ajustar</button>
        </div>
        <div id="alertBusy" class="hint hide">
          <div class="busy"><div class="spinner"></div><div>Pesquisando alerta…</div></div>
          <div class="bar" style="margin-top:8px"></div>
        </div>
        <div id="alertMsg"  class="alert-big hide">—</div>
        <div id="alertResp" class="alert-resp hide">—</div>
      </section>

      <!-- SITES OFICIAIS -->
      <section class="card">
        <div class="tag">SITES OFICIAIS</div>
        <h2>CRION COMERCIAL (AFFIX, ALTER e CONECTA PLAN)</h2>
        <div class="row" style="margin-top:10px">
          <input id="qSites" class="input" placeholder="Digite sua pergunta …..">
          <button id="btnSites" class="btn">Pesquisar</button>
        </div>
        <div id="sitesBusy" class="hint hide">
          <div class="busy"><div class="spinner"></div><div>Pesquisando…</div></div>
          <div class="bar" style="margin-top:8px"></div>
        </div>
        <div id="outSites" class="out">—</div>
      </section>

      <!-- PDFs -->
      <section class="card">
        <div class="tag">PDFs</div>
        <h2>Manuais do Corretor (Sharepoint)</h2>
        <p class="hint">Busca rápida no texto extraído dos PDFs (indexados).</p>
        <div class="row">
          <input id="qPDF" class="input" placeholder="Ex.: Affix, Coparticipação, Carência 30 dias">
          <button id="btnPDF" class="btn" style="min-width:126px">Pesquisar</button>
        </div>
        <div id="pdfBusy" class="hint hide">
          <div class="busy"><div class="spinner"></div><div>Listando arquivos…</div></div>
          <div class="bar" style="margin-top:8px"></div>
        </div>
        <div id="pdfStatus" class="hint" style="margin-top:6px">—</div>
        <ul id="pdfList" class="list"></ul>
      </section>

      <!-- CRION -->
      <section class="card">
        <div class="tag">PROCEDIMENTOS CRION</div>
        <h2>Procedimentos</h2>
        <p class="hint">Material de Treinamento, Quiz, Alertas &gt; 30 dias e demais informações.</p>
        <div class="row">
          <input id="qCRION" class="input" placeholder="Ex.: Onboarding, Retenção, URA, Script de Cobrança, Affix">
          <button id="btnCRION" class="btn" style="min-width:126px">Pesquisar</button>
          <button id="btnReIdxCRION" class="btn btn-danger btn-small" title="Atualiza o índice do CRION">Reindexar</button>
        </div>
        <div id="crionBusy" class="hint hide">
          <div class="busy"><div class="spinner"></div><div>Listando procedimentos…</div></div>
          <div class="bar" style="margin-top:8px"></div>
        </div>
        <div id="crionStatus" class="hint" style="margin-top:6px">—</div>
        <ul id="crionList" class="list"></ul>
      </section>
    </div>

    <footer><span class="badge">Desenvolvido por Alexandre Cavalcante V3.0</span></footer>
  </div>

  <!-- Modais ALERTA -->
  <div id="modal1" class="modal"><div class="modal-box modal-red">
    <h3 class="modal-title">ALERTA DA OPERAÇÃO</h3>
    <input id="m1text" class="input" placeholder="Digite o texto do alerta (vermelho)">
    <div class="modal-actions" style="justify-content:flex-end">
      <button class="btn btn-plain btn-small" onclick="closeM(1)">Cancelar</button>
      <button id="m1ok" class="btn btn-small" onclick="goM2()">Continuar</button>
    </div>
  </div></div>

  <div id="modal2" class="modal"><div class="modal-box" style="border:1px solid #ffdaba">
    <h3 class="modal-title">Responsável</h3>
    <input id="m2text" class="input" style="text-align:center" placeholder="Primeira letra maiúscula (ex.: Ale)">
    <div class="modal-actions" style="justify-content:center">
      <button class="btn btn-plain btn-small" onclick="backM1()">Voltar</button>
      <button id="m2ok" class="btn btn-small" onclick="saveAlert()">Salvar</button>
    </div>
  </div></div>

  <div id="modal3" class="modal"><div class="modal-box" style="border:1px solid #d9f7b8">
    <h3 class="modal-title">ALERTA AJUSTADO</h3>
    <div style="text-align:center;margin-top:8px">✔️</div>
    <div class="modal-actions" style="justify-content:center">
      <button class="btn btn-small" onclick="closeM(3)">OK</button>
    </div>
  </div></div>

<script>
/*** CONFIG ***/
const APP_URL = "COLE_AQUI_SUA_URL_/exec";

/*** POLYFILL (GAS x Web) ***/
const API = (() => {
  const isGAS = !!(window.google && google.script && google.script.run);
  const map = {
    getalert: 'apiGetAlert',
    adjustalert: 'apiAdjustAlert',
    chat: 'chatServer',
    searchindexed: 'apiSearchIndexed',
    fetchindexedsnippets: 'apiFetchIndexedSnippets',
    searchcrion: 'apiSearchCrion',
    fetchcrionsnippets: 'apiFetchCrionSnippets',
    reindexcrion: 'apiReindexCrion'
  };
  function call(path, data){
    if(isGAS){
      return new Promise((resolve,reject)=>{
        const fn = map[path];
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(e=>reject(new Error(e && e.message ? e.message : String(e))))
          [fn](...(data && Object.values(data) || []));
      });
    }else{
      return fetch(APP_URL.replace(/\/$/,'') + "/" + path, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data||{})
      }).then(async r=>{
        if(!r.ok) throw new Error("HTTP "+r.status);
        const ct=(r.headers.get("content-type")||"").toLowerCase();
        if(path==='chat'){ return ct.includes('application/json') ? (await r.json()).text || '' : (await r.text()); }
        return ct.includes('application/json') ? r.json() : JSON.parse(await r.text());
      });
    }
  }
  return { call, isGAS };
})();

/*** Helpers UI ***/
const $ = s => document.querySelector(s);
const show = (el, on=true)=>{ if(!el) return; el.classList[on? 'remove':'add']('hide'); };
function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function cleanName(n){ return String(n||'').replace(/^(OCR_TMP_|TMP_SLIDES_)+/ig,''); }
function link(url, txt){ return `<a href="${url}" target="_blank" rel="noopener">${esc(txt||url)}</a>`; }
function humanSize(b){ if(!b||b<=0) return "—"; const u=["B","KB","MB","GB"]; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; } return b.toFixed(1)+" "+u[i]; }
function capFirst(s){ s=String(s||'').trim(); return s? s[0].toUpperCase()+s.slice(1).toLowerCase() : s; }
function linkify(html){ return String(html||'').replace(/(https?:\/\/[^\s<]+)/g, m=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`); }

/*** ALERTA (exibir) ***/
const elMsg  = $('#alertMsg'); const elResp = $('#alertResp'); const elAlertBusy = $('#alertBusy');
$('#btnAlert').addEventListener('click', async ()=>{
  show(elMsg,false); show(elResp,false); show(elAlertBusy,true);
  try{
    const res = await API.call("getalert",{});
    if(!res || res.ok===false){ elMsg.innerHTML="Falha ao consultar."; show(elMsg,true); return; }
    if(!res.found){ elMsg.innerHTML="Sem recado no momento."; show(elMsg,true); return; }
    const msg = esc(String(res.mensagem||"—").toUpperCase());
    elMsg.innerHTML = `<span class="siren">🚨</span>${msg}`;
    show(elMsg,true);
    if(res.responsavel){ elResp.textContent = String(res.responsavel||"").toLowerCase(); show(elResp,true); }
  }catch(e){ elMsg.textContent = "Erro: "+e.message; show(elMsg,true);
  }finally{ show(elAlertBusy,false); }
});

/*** ALERTA (ajuste) ***/
let _newAlert="", _newResp="";
function openM(id){ $('#modal'+id).classList.add('show'); }
function closeM(id){ $('#modal'+id).classList.remove('show'); }
function backM1(){ closeM(2); openM(1); }
$('#btnAdjust').addEventListener('click', ()=>{ _newAlert=""; _newResp=""; $('#m1text').value=""; $('#m2text').value=""; openM(1); });
function goM2(){ _newAlert = ($('#m1text').value||"").trim(); if(!_newAlert){ $('#m1text').focus(); return; } closeM(1); openM(2); }
$('#m2text').addEventListener('input', e=>{
  const v = e.target.value.replace(/\s+/g,' ').trim();
  e.target.value = v ? capFirst(v) : v;
});
async function saveAlert(){
  _newResp = ($('#m2text').value||"").trim();
  const btn = $('#m2ok'); btn.disabled = true; btn.textContent = 'Gravando…';
  try{ await API.call("adjustalert",{mensagem:_newAlert, responsavel:_newResp}); closeM(2); openM(3);
  }catch(e){ closeM(2); alert("Falha ao ajustar: "+e.message);
  }finally{ btn.disabled=false; btn.textContent='Salvar'; }
}

/*** SITES (texto longo + fontes) ***/
$('#btnSites').addEventListener('click', async ()=>{
  const q=($('#qSites').value||'').trim();
  if(!q){ $('#outSites').textContent='Digite a pergunta.'; return; }
  show($('#sitesBusy'),true); $('#outSites').innerHTML='—';
  try{
    const qRich = q + " — FORMATO: responda em português com texto longo (50–90% do conteúdo relevante) e liste as URLs oficiais no final.";
    let txt = await API.call("chat",{q:qRich, ua:navigator.userAgent||''});
    txt = String(txt||'—').replace(/_?\s*Observa[cç][oõ]es:\s.*$/gmi, '').trim();
    if(!/Fontes oficiais: Affix • Alter • Hapvida/i.test(txt)){
      txt = txt.replace(/\s+$/,'') + "\n\nFontes oficiais: Affix • Alter • Hapvida";
    }
    $('#outSites').innerHTML = linkify(txt);
  }catch(e){ $('#outSites').textContent = 'Erro: '+e.message;
  }finally{ show($('#sitesBusy'),false); }
});

/*** PDFs ***/
$('#btnPDF').addEventListener('click', doPDF);
$('#qPDF').addEventListener('keydown', e=>{ if(e.key==='Enter') doPDF(); });
async function doPDF(){
  const q=($('#qPDF').value||'').trim(); if(!q){ $('#pdfStatus').textContent='Digite um termo.'; return; }
  show($('#pdfBusy'),true); $('#pdfStatus').textContent='Listando arquivos…'; $('#pdfList').innerHTML="";
  try{
    const res = await API.call("searchindexed",{q, ua:navigator.userAgent||''});
    if(!res || res.ok===false){ $('#pdfStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; $('#pdfStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='pdf_'+idx;
      const meta = `<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_pdf_${idx}">Carregando prévias…</div>`;
      frag.appendChild(li);
    });
    $('#pdfList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r = await API.call("fetchindexedsnippets",{sessionId:res.sessionId, from, limit:6});
        (r.items||[]).forEach(row=>{
          const el=$('#snip_pdf_'+row.index);
          el.innerHTML=(row.snippets && row.snippets.length)? row.snippets.map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="hint">—</span>';
        });
        from = r.to;
      }
      $('#pdfStatus').textContent += " • prévias completas";
    }
  }catch(e){ $('#pdfStatus').textContent='Erro: '+e.message;
  }finally{ show($('#pdfBusy'),false); }
}

/*** CRION ***/
$('#btnCRION').addEventListener('click', doCRION);
$('#qCRION').addEventListener('keydown', e=>{ if(e.key==='Enter') doCRION(); });
$('#btnReIdxCRION').addEventListener('click', async ()=>{
  $('#crionStatus').textContent='Reindexando CRION…'; show($('#crionBusy'),true);
  try{ const r=await API.call("reindexcrion",{}); $('#crionStatus').textContent="Index CRION: "+(r && r.ok ? "OK" : "Falhou"); }
  catch(e){ $('#crionStatus').textContent='Erro: '+e.message; }
  finally{ show($('#crionBusy'),false); }
});
async function doCRION(){
  const q=($('#qCRION').value||'').trim(); if(!q){ $('#crionStatus').textContent='Digite um termo.'; return; }
  show($('#crionBusy'),true); $('#crionStatus').textContent='Listando arquivos…'; $('#crionList').innerHTML="";
  try{
    const res = await API.call("searchcrion",{q, ua:navigator.userAgent||''});
    if(!res || res.ok===false){ $('#crionStatus').textContent='Erro ao buscar: '+(res&&res.message?res.message:''); return; }
    const items=res.items||[]; $('#crionStatus').textContent=`Resultados: ${items.length}`;
    const frag=document.createDocumentFragment();
    items.forEach((it,idx)=>{
      const li=document.createElement('li'); li.className='item'; li.id='crion_'+idx;
      const meta  = `<div class="meta">Tamanho: ${humanSize(it.size||0)} • Atualizado: ${it.updated? new Date(it.updated).toLocaleString(): "—"}</div>`;
      li.innerHTML=`<div><b>${esc(cleanName(it.name))}</b> • ${link(it.url,'Abrir')}</div>${meta}
                    <div class="hint" id="snip_crion_${idx}">Carregando prévias…</div>`;
      frag.appendChild(li);
    });
    $('#crionList').appendChild(frag);
    if(items.length){
      let from=0;
      while(from < items.length){
        const r = await API.call("fetchcrionsnippets",{sessionId:res.sessionId, from, limit:6});
        (r.items||[]).forEach(row=>{
          const el=$('#snip_crion_'+row.index);
          el.innerHTML=(row.snippets && row.snippets.length)? row.snippets map(s=>`<div class="snip">${esc(s)}</div>`).join("") : '<span class="hint">—</span>';
        });
        from = r.to;
      }
      $('#crionStatus').textContent += " • prévias completas";
    }
  }catch(e){ $('#crionStatus').textContent='Erro: '+e.message;
  }finally{ show($('#crionBusy'),false); }
}
</script>
</body>
</html>
